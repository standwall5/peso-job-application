"use client";

import React, { useState } from "react";
import styles from "@/app/admin/company-profiles/components/Exams.module.css";
import Button from "@/components/Button";

// Answer type: can be a single choice ID, multiple choice IDs, or text
type ExamAnswer = number | number[] | string;

// Exam Interface
export interface Exam {
  id: number;
  title: string;
  description: string;
  questions: Question[];
}

// Question Interface
export interface Question {
  id: number;
  exam_id: number;
  question_text: string;
  question_type: string;
  position: number;
  choices: Choice[];
}

// Choice Interface
export interface Choice {
  id: number;
  question_id: number;
  choice_text: string;
  position: number;
}

interface TakeExamProps {
  exam: Exam;
  onSubmit?: (answers: Record<number, ExamAnswer>) => void;
  onClose?: () => void;
}

const TakeExam: React.FC<TakeExamProps> = ({ exam, onSubmit, onClose }) => {
  const [answers, setAnswers] = useState<Record<number, ExamAnswer>>({});

  const handleMultipleChoiceChange = (questionId: number, choiceId: number) => {
    setAnswers({ ...answers, [questionId]: choiceId });
  };

  const handleCheckboxChange = (questionId: number, choiceId: number) => {
    const currentAnswers = (answers[questionId] as number[]) || [];
    if (currentAnswers.includes(choiceId)) {
      setAnswers({
        ...answers,
        [questionId]: currentAnswers.filter((id) => id !== choiceId),
      });
    } else {
      setAnswers({
        ...answers,
        [questionId]: [...currentAnswers, choiceId],
      });
    }
  };

  const handleParagraphChange = (questionId: number, text: string) => {
    setAnswers({ ...answers, [questionId]: text });
  };

  const handleSubmitExam = () => {
    if (onSubmit) {
      onSubmit(answers);
    }
  };

  return (
    <div>
      <div className={styles.header}>
        <h2
          style={{
            fontSize: "1.5rem",
            fontWeight: "bold",
            marginBottom: "0.5rem",
          }}
        >
          {exam.title}
        </h2>
        <p style={{ color: "#666", marginBottom: "1rem" }}>
          {exam.description}
        </p>
      </div>

      <div className={styles.modalContent}>
        {exam.questions && exam.questions.length > 0 ? (
          exam.questions.map((question) => (
            <div key={question.id} className={styles.questionBlock}>
              <div className={styles.questionHeader}>
                <div className={styles.questionText}>
                  <h4>
                    <span>{question.position}. </span>
                    {question.question_text}
                  </h4>
                </div>
              </div>

              {/* Multiple Choice */}
              {question.question_type === "multiple-choice" && (
                <div style={{ marginTop: "1rem" }}>
                  {question.choices.map((choice) => (
                    <label
                      key={choice.id}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: "0.5rem",
                        marginBottom: "0.75rem",
                        cursor: "pointer",
                        padding: "0.75rem",
                        border: "1px solid #ddd",
                        borderRadius: "8px",
                        background:
                          answers[question.id] === choice.id
                            ? "#f0f7ff"
                            : "#fff",
                        transition: "all 0.2s ease",
                      }}
                    >
                      <input
                        type="radio"
                        name={`question-${question.id}`}
                        value={choice.id}
                        checked={answers[question.id] === choice.id}
                        onChange={() =>
                          handleMultipleChoiceChange(question.id, choice.id)
                        }
                        style={{ cursor: "pointer" }}
                      />
                      <span>{choice.choice_text}</span>
                    </label>
                  ))}
                </div>
              )}

              {/* Checkboxes */}
              {question.question_type === "checkboxes" && (
                <div style={{ marginTop: "1rem" }}>
                  {question.choices.map((choice) => (
                    <label
                      key={choice.id}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: "0.5rem",
                        marginBottom: "0.75rem",
                        cursor: "pointer",
                        padding: "0.75rem",
                        border: "1px solid #ddd",
                        borderRadius: "8px",
                        background: (
                          answers[question.id] as number[]
                        )?.includes(choice.id)
                          ? "#f0f7ff"
                          : "#fff",
                        transition: "all 0.2s ease",
                      }}
                    >
                      <input
                        type="checkbox"
                        checked={
                          (answers[question.id] as number[])?.includes(
                            choice.id,
                          ) || false
                        }
                        onChange={() =>
                          handleCheckboxChange(question.id, choice.id)
                        }
                        style={{ cursor: "pointer" }}
                      />
                      <span>{choice.choice_text}</span>
                    </label>
                  ))}
                </div>
              )}

              {/* Paragraph */}
              {question.question_type === "paragraph" && (
                <div style={{ marginTop: "1rem" }}>
                  <textarea
                    value={(answers[question.id] as string) || ""}
                    onChange={(e) =>
                      handleParagraphChange(question.id, e.target.value)
                    }
                    placeholder="Type your answer here..."
                    rows={5}
                    style={{
                      width: "100%",
                      minHeight: "120px",
                      borderRadius: "8px",
                      border: "1px solid #ddd",
                      padding: "0.75rem",
                      resize: "vertical",
                      fontSize: "1rem",
                    }}
                  />
                </div>
              )}
            </div>
          ))
        ) : (
          <div style={{ fontSize: "1rem", color: "#666", marginTop: "2rem" }}>
            <p>No questions available for this exam.</p>
          </div>
        )}
      </div>

      <div
        style={{
          display: "flex",
          gap: "1rem",
          marginTop: "2rem",
          justifyContent: "flex-end",
        }}
      >
        {onClose && (
          <Button variant="primary" onClick={onClose}>
            Cancel
          </Button>
        )}
        <Button variant="success" onClick={handleSubmitExam}>
          Submit Exam
        </Button>
      </div>
    </div>
  );
};

export default TakeExam;
